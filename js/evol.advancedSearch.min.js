/*
   evol.advancedSearch 1.0.1
   (c) 2013 Olivier Giulieri
*/
!function(a){var b={sEqual:"equals",sNotEqual:"not equal",sStart:"starts with",sContain:"contains",sFinish:"finishes with",sInList:"any of",sIsNull:"is empty",sIsNotNull:"is not empty",sBefore:"before",sAfter:"after",sNumEqual:"&#61;",sNumNotEqual:"!&#61;",sGreater:"&#62;",sSmaller:"&#60;",sOn:"on",sNotOn:"not on",sAt:"at",sNotAt:"not at",sBetween:"between",opAnd:"and",yes:"Yes",no:"No",bNewFilter:"New filter",bAddFilter:"Add filter",bUpdateFilter:"Update filter",bSubmit:"Submit",bCancel:"Cancel"},c={sEqual:"eq",sNotEqual:"ne",sStart:"sw",sContain:"ct",sFinish:"fw",sInList:"in",sIsNull:"null",sIsNotNull:"nn",sGreater:"gt",sSmaller:"lt",sBetween:"bw"},d={text:"text",bool:"boolean",number:"number",date:"date",time:"time",lov:"lov"};a.widget("evol.advancedSearch",{version:"1.0.1",options:{fields:[],dateFormat:"mm/dd/yy",highlight:!0,buttonLabels:!1,submitButton:!1,submitReady:!1},_create:function(){var e=this.options.buttonLabels,f=this,g=this.element,h=['<div class="evo-searchFilters"></div>','<a class="evo-bNew" href="javascript:void(0)">',b.bNewFilter,"</a>"];this.options.submitButton&&h.push('<a class="evo-bSubmit" href="javascript:void(0)">',b.bSubmit,"</a>"),h.push('<div class="evo-editFilter"></div>','<a class="evo-bAdd" style="display:none;" href="javascript:void(0)">',b.bAddFilter,"</a>",'<a class="evo-bDel" style="display:none;" href="javascript:void(0)">',b.bCancel,"</a>"),this._step=0,g.addClass("evo-advSearch ui-widget-content ui-corner-all").html(h.join("")),this.options.submitReady&&(this._hValues=a("<span></span>").appendTo(g)),this.options.submitButton&&(this._bSubmit=g.find(".evo-bSubmit").button({text:e}).on("click",function(){f.element.trigger("submit.search")})),this._bNew=g.find(".evo-bNew").button({text:e,icons:{secondary:"ui-icon-plusthick"}}).on("click",function(){f._step<1&&(f._setEditorField(),f._step=1),f._bAdd.find(".ui-button-text").html(b.bAddFilter)}),this._bAdd=g.find(".evo-bAdd").button({text:e,icons:{secondary:"ui-icon-check"}}).on("click",function(){var a=f._getEditorData();f._cFilter?f._enableFilter(a,f.options.highlight):f.addFilter(a),f._removeEditor()}),this._bDel=g.find(".evo-bDel").button({text:e,icons:{secondary:"ui-icon-close"}}).on("click",function(){f._removeEditor()}),this._editor=g.find(".evo-editFilter").on("change","#field",function(b){b.stopPropagation(),f._step>2&&f._editor.find("#value,#value2,.as-Txt").remove(),f._step>1&&(f._editor.find("#operator").remove(),f._bAdd.hide()),f._step=1;var c=a(b.currentTarget).val();if(""!==c){f._field=f._getFieldById(c);var e=f._type=f._field.type;f._setEditorOperator(),(e==d.lov||e==d.bool)&&f._setEditorValue()}else f._field=f._type=null}).on("change","#operator",function(b){b.stopPropagation(),f._operator=a(this).val(),f._step>2&&(f._editor.find("#value,#value2,.as-Txt").remove(),f._bAdd.hide(),f._step=2),f._setEditorValue()}).on("change keyup","#value,#value2",function(b){b.stopPropagation();var e=f._type,g=a(this).val(),h=""!==g||e==d.lov||e==d.bool;e==d.number?h=h&&!isNaN(g):f._operator==c.sBetween&&(h=""!==f._editor.find("#value").val()&&""!==f._editor.find("#value2").val()),h?(f._bAdd.button("enable"),13==b.which&&f._bAdd.trigger("click")):f._bAdd.button("disable")}).on("click","#checkAll",function(){var b=a(this),c=b.attr("checked"),d=b.siblings();"checked"==c?d.attr("checked",c):d.removeAttr("checked")}),this._filters=g.find(".evo-searchFilters").on("click","a",function(){f._editFilter(a(this))}).on("click","a .ui-button-icon-secondary",function(b){b.stopPropagation();var c=a(this).parent();c.hasClass("ui-state-disabled")||c.fadeOut("slow",function(){c.remove(),f._triggerChange()})})},_getFieldById:function(a){if(!this._hash){this._hash={};for(var b=this.options.fields,c=0,d=b.length;d>c;c++)this._hash[b[c].id]=b[c]}return this._hash[a]},_removeEditor:function(){this._editor.empty(),this._bAdd.hide(),this._bDel.hide(),this._enableFilter(null,!1),this._bNew.removeClass("ui-state-active").show().focus(),this._bSubmit&&this._bSubmit.removeClass("ui-state-active").show(),this._step=0,this._field=this._type=this._operator=null},addFilter:function(b){var c=a(['<a href="javascript:void(0)">',this._htmlFilter(b),"</a>"].join("")).prependTo(this._filters).button({icons:{secondary:"ui-icon-close"}}).data("filter",b).fadeIn();return this.options.highlight&&c.effect("highlight"),this._triggerChange(),this},removeFilter:function(a){return this._filters.children().eq(a).remove(),this._triggerChange(),this},_htmlFilter:function(a){var d=['<span class="evo-lBold">',a.field.label,"</span> ",'<span class="evo-lLight">',a.operator.label,"</span> ",'<span class="evo-lBold">',a.value.label,"</span>"];return a.operator.value==c.sBetween&&d.push('<span class="evo-lLight"> ',b.opAnd," </span>",'<span class="evo-lBold">',a.value.label2,"</span>"),d.join("")},_enableFilter:function(a,b){this._cFilter&&(this._cFilter.button("enable").removeClass("ui-state-hover ui-state-active"),b&&this._cFilter.effect("highlight"),a?(this._cFilter.data("filter",a).find(":first-child").html(this._htmlFilter(a)),this._cFilter=null,this._triggerChange()):this._cFilter=null)},_editFilter:function(a){var d=a.data("filter"),e=d.field.value,f=d.operator.value,g=d.value;this._enableFilter(null,!1),this._removeEditor(),this._cFilter=a.button("disable"),this._getFieldById(e).type,this._setEditorField(e),this._setEditorOperator(f),f==c.sBetween?this._setEditorValue(g.value,g.value2):this._setEditorValue(g.value),this._bAdd.find(".ui-button-text").html(b.bUpdateFilter),this._step=3},_setEditorField:function(b){if(this._step<1){if(this._bNew.stop().hide(),this._bSubmit&&this._bSubmit.stop().hide(),this._bDel.show(),!this._fList){for(var c=this.options.fields,d=['<select id="field"><option value=""></option>'],f=0,g=c.length;g>f;f++){var h=c[f];d.push(e.inputOption(h.id,h.label))}d.push("</select>"),this._fList=d.join("")}a(this._fList).appendTo(this._editor).focus()}b&&(this._field=this._getFieldById(b),this._type=this._field.type,this._editor.find("#field").val(b)),this._step=1},_setEditorOperator:function(a){var f=this._type;if(this._step<2){var g=[];switch(f){case d.lov:g.push(e.inputHidden("operator",c.sInList)),this._operator=c.sInList;break;case d.bool:g.push(e.inputHidden("operator",c.sEqual)),this._operator=c.sEqual;break;default:switch(g.push('<select id="operator"><option value=""></option>'),f){case d.date:case d.time:f==d.time?g.push(e.inputOption(c.sEqual,b.sAt),e.inputOption(c.sNotEqual,b.sNotAt)):g.push(e.inputOption(c.sEqual,b.sOn),e.inputOption(c.sNotEqual,b.sNotOn)),g.push(e.inputOption(c.sGreater,b.sAfter),e.inputOption(c.sSmaller,b.sBefore),e.inputOption(c.sBetween,b.sBetween));break;case d.number:g.push(e.inputOption(c.sEqual,b.sNumEqual),e.inputOption(c.sNotEqual,b.sNumNotEqual),e.inputOption(c.sGreater,b.sGreater),e.inputOption(c.sSmaller,b.sSmaller));break;default:g.push(e.inputOption(c.sEqual,b.sEqual),e.inputOption(c.sNotEqual,b.sNotEqual),e.inputOption(c.sStart,b.sStart),e.inputOption(c.sContain,b.sContain),e.inputOption(c.sFinish,b.sFinish))}g.push(e.inputOption(c.sIsNull,b.sIsNull),e.inputOption(c.sIsNotNull,b.sIsNotNull)),g.push("</select>")}this._editor.append(g.join(""))}a&&f!=d.lov&&(this._editor.find("#operator").val(a),this._operator=a),this._step=2},_setEditorValue:function(a,f){var g=this._editor,h=this._type,i=g.find("#operator").val(),j=!1,k=!0;if(""!==i){if(h==d.lov||i!=c.sIsNull&&i!=c.sIsNotNull){if(this._step<3){var l=[];switch(j=i==c.sBetween,h){case d.lov:l.push('<span id="value">'),this._field.list.length>7&&l.push('(<input type="checkbox" id="checkAll" value="1"/><label for="checkAll">All</label>) '),l.push(e.inputCheckboxLOV(this._field.list)),l.push("</span>");break;case d.bool:l.push('<span id="value">',e.inputRadio("value","1",b.yes,"0"!=a,"value1"),e.inputRadio("value","0",b.no,"0"==a,"value0"),"</span>");break;case d.date:case d.time:case d.number:var m=h==d.date?"text":h;l.push('<input id="value" type="',m,'"/>'),j&&l.push('<span class="as-Txt">',b.opAnd," </span>",'<input id="value2" type="',m,'"/>'),k=!1;break;default:l.push('<input id="value" type="text"/>'),k=!1}g.append(l.join("")),h==d.date&&g.find("#value,#value2").datepicker({dateFormat:this.options.dateFormat})}if(a){var n=g.find("#value");switch(h){case d.lov:n.find("#"+a.split(",").join(",#")).attr("checked","checked");break;case d.bool:n.find("#value"+a).attr("checked","checked");break;default:n.val(a),k=""!==a,j&&(n.next().next().val(f),k=""!==a&&""!==f)}}else k=h==d.lov||h==d.bool}else g.append(e.inputHidden("value",""));this._bAdd.button(k?"enable":"disable").show(),this._step=3}},_getEditorData:function(){var a=this._editor,e=a.find("#field"),f=a.find("#value"),g={field:{label:e.find("option:selected").text(),value:e.val()},operator:{},value:{}},h=g.operator,i=g.value;if(this._type==d.lov){var j=[],k=[];f.find("input:checked").not("#checkAll").each(function(){j.push(this.value),k.push(this.nextSibling.innerHTML)}),0===j.length?(h.label=b.sIsNull,h.value=c.sIsNull,i.label=i.value=""):1==j.length?(h.label=b.sEqual,h.value=c.sEqual,i.label='"'+k[0]+'"',i.value=j[0]):(h.label=b.sInList,h.value=c.sInList,i.label="("+k.join(", ")+")",i.value=j.join(","))}else if(this._type==d.bool){h.label=b.sEqual,h.value=c.sEqual;var l="checked"==f.find("#value1").attr("checked")?1:0;i.label=1==l?b.yes:b.no,i.value=l}else{var m=a.find("#operator"),n=m.val();h.label=m.find("option:selected").text(),h.value=n,n==c.sIsNull||n==c.sIsNotNull?i.label=i.value="":(i.label=this._type==d.number||this._type==d.date||this._type==d.time?f.val():'"'+f.val()+'"',i.value=f.val(),n==c.sBetween&&(i.label2=i.value2=f.next().next().val()))}return g},_hiddenValue:function(a,b,c){a.push(e.inputHidden("fld-"+c,b.field.value),e.inputHidden("op-"+c,b.operator.value),e.inputHidden("val-"+c,b.value.value));var d=b.value.value2;d&&a.push(e.inputHidden("val2-"+c,d))},_setHiddenValues:function(){for(var a=this.val(),b=a.length,c=[e.inputHidden("elem",b)],d=0;b>d;d++)this._hiddenValue(c,a[d],d+1);this._hValues.html(c.join(""))},_triggerChange:function(){this.options.submitReady&&this._setHiddenValues(),this.element.trigger("change.search")},val:function(b){if("undefined"==typeof b){var c=[];return this._filters.find("a").each(function(){c.push(a(this).data("filter"))}),c}this._filters.empty();for(var d=0,e=b.length;e>d;d++)this.addFilter(b[d]);return this._triggerChange(),this},valText:function(){var a=[];return this._filters.find("a").each(function(){a.push(this.text)}),a.join(" "+b.opAnd+" ")},valUrl:function(){var a=this.val(),b=a.length,d=["filters=",b];if(1>b)return"";for(var e=0;b>e;e++){var f=a[e];d.push("&field-",e,"=",f.field.value,"&operator-",e,"=",f.operator.value,"&value-",e,"=",encodeURIComponent(f.value.value)),f.operator==c.sBetween&&d.push("&value2-",e,"=",encodeURIComponent(f.value.value2))}return d.push("&label=",encodeURIComponent(this.valText())),d.join("")},empty:function(){return this._cFilter=null,this._removeEditor(),this._filters.empty(),this._triggerChange(),this},length:function(){return this._filters.children().length},destroy:function(){var b=this.element.off();b.find(".evo-bNew,.evo-bAdd,.evo-bDel,.evo-searchFilters").off(),this._editor.off(),b.empty().removeClass("evo-advSearch ui-widget-content ui-corner-all"),a.Widget.prototype.destroy.call(this)}});var e={inputRadio:function(a,b,c,d,e){var f=['<label for="',e,'"><input id="',e,'" name="',a,'" type="radio" value="',b];return d&&f.push('" checked="checked'),f.push('">',c,"</label>&nbsp;"),f.join("")},inputHidden:function(a,b){return['<input type="hidden" name="',a,'" value="',b,'"/>'].join("")},inputOption:function(a,b){return['<option value="',a,'">',b,"</option>"].join("")},inputCheckboxLOV:function(a){var b=[];for(var c in a){var d=a[c];b.push('<input type="checkbox" id="',d.id,'" value="',d.id,'"/>','<label for="',d.id,'">',d.label,"</label> ")}return b.join("")}}}(jQuery);