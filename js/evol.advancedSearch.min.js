/*
   evol.advancedSearch 1.0.1
   (c) 2013 Olivier Giulieri
*/
!function(a){var b={sEqual:"equals",sNotEqual:"not equal",sStart:"starts with",sContain:"contains",sFinish:"finishes with",sInList:"any of",sIsNull:"is empty",sIsNotNull:"is not empty",sBefore:"before",sAfter:"after",sNumEqual:"&#61;",sNumNotEqual:"!&#61;",sGreater:"&#62;",sSmaller:"&#60;",sOn:"on",sNotOn:"not on",sAt:"at",sNotAt:"not at",sBetween:"between",sOpPlaceHolder:"Select operator",sLike:"like",opAnd:"AND",opOr:"OR",yes:"Yes",no:"No",bNewFilter:"New filter",bAddFilter:"Add filter",bUpdateFilter:"Update filter",bSubmit:"Submit",bCancel:"Cancel"},c={sEqual:"eq",sNotEqual:"ne",sStart:"sw",sContain:"ct",sFinish:"fw",sInList:"in",sIsNull:"null",sIsNotNull:"nn",sGreater:"gt",sSmaller:"lt",sBetween:"bw",sLike:"lk"},d={text:"text",bool:"boolean",number:"number",date:"date",time:"time",lov:"lov"};a.widget("evol.advancedSearch",{version:"1.0.1",options:{fields:[],dateFormat:"mm/dd/yy",highlight:!0,buttonLabels:!1,submitButton:!1,submitReady:!1,defaultOperator:!1,lang:b,enableSelect2:!1,placeholder:"Select field"},_create:function(){var e=this.options.buttonLabels,f=this,g=this.element,h=['<div class="evo-searchFilters"></div>','<a class="evo-bNew" href="javascript:;">',b.bNewFilter,"</a>"];b=this.options.lang,this.options.submitButton&&h.push('<a class="evo-bSubmit" href="javascript:;">',b.bSubmit,"</a>"),h.push('<div class="evo-editFilter"></div>','<a class="evo-bAdd" style="display:none;" href="javascript:;">',b.bAddFilter,"</a>",'<a class="evo-bDel" style="display:none;" href="javascript:;">',b.bCancel,"</a>"),this._step=0,g.addClass("evo-advSearch ui-widget-content ui-corner-all").html(h.join("")),this.options.submitReady&&(this._hValues=a("<span></span>").appendTo(g)),this.options.submitButton&&(this._bSubmit=g.find(".evo-bSubmit").button({text:e}).on("click",function(){f.element.trigger("submit.search")})),this._bNew=g.find(".evo-bNew").button({text:e,icons:{secondary:"ui-icon-plusthick"}}).on("click",function(){f._step<1&&(f._setEditorField(),f._step=1),f._bAdd.find(".ui-button-text").html(b.bAddFilter)}),this._bAdd=g.find(".evo-bAdd").button({text:e,icons:{secondary:"ui-icon-check"}}).on("click",function(){var a=f._getEditorData();a&&(f._cFilter?f._enableFilter(a,f.options.highlight):f.addFilter(a)),f._removeEditor()}),this._bDel=g.find(".evo-bDel").button({text:e,icons:{secondary:"ui-icon-close"}}).on("click",function(){f._removeEditor()}),this._editor=g.find(".evo-editFilter").on("change","#field",function(b){b.stopPropagation(),f._step>2&&(f.options.enableSelect2&&f._editor.find("#lov,#value,#value2").select2("destroy").remove(),f._editor.find("#value,#value2,.as-Txt").remove()),f._step>1&&(f.options.enableSelect2&&f._editor.find("#operator").select2("destroy"),f._editor.find("#operator").remove(),f._bAdd.hide()),f._step=1;var c=a(b.currentTarget).val();if(""!==c){f._field=f._getFieldById(c);var e=f._type=f._field.type;f._field.opDefault?(f._setEditorOperator(f._field.opDefault),a("#operator").trigger("change")):f._setEditorOperator(),(e==d.lov||e==d.bool)&&f._setEditorValue()}else f._field=f._type=null}).on("change","#operator",function(b){b.stopPropagation(),f._operator=a(this).val(),f._step>2&&(f._editor.find("#value,#value2,.as-Txt").remove(),f._bAdd.hide(),f._step=2),f._setEditorValue()}).on("change keyup","#value,#value2",function(b){b.stopPropagation();var e=f._type,g=a(this).val(),h=""!==g||e==d.lov||e==d.bool;e==d.number&&f._operator==c.sBetween?h=h&&!isNaN(f._editor.find("#value").val())&&!isNaN(f._editor.find("#value2").val()):e==d.number||f._operator==c.sBetween&&(h=""!==f._editor.find("#value").val()&&""!==f._editor.find("#value2").val()),h?(f._bAdd.button("enable"),13==b.which&&f._bAdd.trigger("click")):f._bAdd.button("disable")}).on("click","#checkAll",function(){var b=a(this),c=b.attr("checked"),d=b.siblings();"checked"==c?d.attr("checked",c):d.removeAttr("checked")}),this._filters=g.find(".evo-searchFilters").on("click","a",function(){f._editFilter(a(this))}).on("click","a .ui-button-icon-secondary",function(b){b.stopPropagation();var c=a(this).parent(),d=c.index();c.hasClass("ui-state-disabled")||c.fadeOut("slow",function(){c.remove(),f._triggerChange()}),0===d&&f.length()>1&&(nextFilter=f._filters.children().eq(1),delete nextFilter.data("filter").andor,nextFilter.button({label:f._htmlFilter(nextFilter.data("filter")),icons:{secondary:"ui-icon-close"}}))})},_getFieldById:function(a){if(!this._hash){this._hash={};for(var b=this.options.fields,c=0,d=b.length;d>c;c++)this._hash[b[c].id]=b[c]}return this._hash[a]},_removeEditor:function(){this._editor.empty(),this._bAdd.hide(),this._bDel.hide(),this._enableFilter(null,!1),this._bNew.removeClass("ui-state-active").show().focus(),this._bSubmit&&this._bSubmit.removeClass("ui-state-active").show(),this._step=0,this._field=this._type=this._operator=null},addFilter:function(b){var c=a(['<a href="javascript:;">',this._htmlFilter(b),"</a>"].join("")).appendTo(this._filters).button({icons:{secondary:"ui-icon-close"}}).data("filter",b).fadeIn();return this.options.highlight&&c.effect("highlight"),this._triggerChange(),this},removeFilter:function(a){return this._filters.children().eq(a).remove(),this._triggerChange(),this},_htmlFilter:function(a){var d=[];return a.andor&&d.push('<span class="lLight-Red">',a.andor.label,"</span> "),d.push('<span class="evo-lBold">',a.field.label,"</span> ",'<span class="evo-lLight">',a.operator.label,"</span> ",'<span class="evo-lBold">',a.value.label,"</span>"),a.operator.value==c.sBetween&&d.push('<span class="evo-lLight"> ',b.opAnd," </span>",'<span class="evo-lBold">',a.value.label2,"</span>"),d.join("")},_enableFilter:function(a,b){this._cFilter&&(this._cFilter.button("enable").removeClass("ui-state-hover ui-state-active"),b&&this._cFilter.effect("highlight"),a?(this._cFilter.data("filter",a).find(":first-child").html(this._htmlFilter(a)),this._cFilter=null,this._triggerChange()):this._cFilter=null)},_editFilter:function(d){var e=d.data("filter"),f=e.field.value,g=e.operator.value,h=e.value;this._enableFilter(null,!1),this._removeEditor(),this._cFilter=d.button("disable");this._getFieldById(f).type;e.andor?this._setEditorField(f,e.andor.value):this._setEditorField(f),this._setEditorOperator(g),this.options.defaultOperator&&a("#operator").val(this.options.defaultOperator).hide(),g==c.sBetween?this._setEditorValue(h.value,h.value2):this._setEditorValue(h.value),this._bAdd.find(".ui-button-text").html(b.bUpdateFilter),this._step=3},_setEditorField:function(c,d){var f=!1;if(this._step<1){if(this._bNew.stop().hide(),this._bSubmit&&this._bSubmit.stop().hide(),this._bDel.show(),(this.length()>0||c)&&(this._fList=null),(this.length()>0&&!c||d)&&(f=!0),!this._fList){var g=this.options.fields,h=[];f&&h.push('<select id="andOr"><option value="and">'+b.opAnd+'</option><option value="or">'+b.opOr+"</option></select>"),h.push('<select id="field"><option value=""></option>');for(var i=0,j=g.length;j>i;i++){var k=g[i];h.push(e.inputOption(k.id,k.label))}h.push("</select>"),this._fList=h.join("")}a(this._fList).appendTo(this._editor).focus()}c&&(this._field=this._getFieldById(c),this._type=this._field.type,this._editor.find("#field").val(c)),d&&this._editor.find("#andOr").val(d),this.options.enableSelect2&&(f&&a("#andOr").select2({width:"element"}),a("#field").select2({width:"element",placeholder:this.options.placeholder})),this._step=1},_setEditorOperator:function(f){var g=this._type;if(this._step<2){var h=[];switch(g){case d.lov:h.push(e.inputHidden("operator",c.sInList)),this._operator=c.sInList;break;case d.bool:h.push(e.inputHidden("operator",c.sEqual)),this._operator=c.sEqual;break;default:if(h.push('<select id="operator"><option value=""></option>'),this._field.opList)a.map(this._field.opList,function(a){h.push(e.inputOption(c[a],b[a]))});else{switch(g){case d.date:case d.time:g==d.time?h.push(e.inputOption(c.sEqual,b.sAt),e.inputOption(c.sNotEqual,b.sNotAt)):h.push(e.inputOption(c.sEqual,b.sOn),e.inputOption(c.sNotEqual,b.sNotOn)),h.push(e.inputOption(c.sGreater,b.sAfter),e.inputOption(c.sSmaller,b.sBefore),e.inputOption(c.sBetween,b.sBetween));break;case d.number:h.push(e.inputOption(c.sEqual,b.sNumEqual),e.inputOption(c.sNotEqual,b.sNumNotEqual),e.inputOption(c.sGreater,b.sGreater),e.inputOption(c.sSmaller,b.sSmaller));break;default:h.push(e.inputOption(c.sEqual,b.sEqual),e.inputOption(c.sLike,b.sLike),e.inputOption(c.sNotEqual,b.sNotEqual),e.inputOption(c.sStart,b.sStart),e.inputOption(c.sContain,b.sContain),e.inputOption(c.sFinish,b.sFinish))}h.push(e.inputOption(c.sIsNull,b.sIsNull),e.inputOption(c.sIsNotNull,b.sIsNotNull))}h.push("</select>")}this._editor.append(h.join(""))}f&&g!=d.lov&&(this._editor.find("#operator").val(f),this._operator=f),this._field.opHide&&a("#operator").hide(),this.options.enableSelect2&&!this._field.opHide&&a("#operator").select2(this._field.opPlaceholder?{width:"element",placeholder:this._field.opPlaceholder}:{width:"element",placeholder:b.sOpPlaceHolder}),this._step=2},_setEditorValue:function(f,g){var h=this._editor,i=this._type,j=h.find("#operator").val(),k=!1,l=!0;if(""!==j){if(i==d.lov||j!=c.sIsNull&&j!=c.sIsNotNull){if(this._step<3){var m=[];switch(k=j==c.sBetween,i){case d.lov:if(this.options.enableSelect2){selectMultiple="",this._field.listSingle||(selectMultiple="multiple"),m.push('<select id="lov" '+selectMultiple+">","<option></option>");for(var n in this._field.list){var o=this._field.list[n];m.push('<option value="'+o.id+'">'+o.label+"</option>")}m.push("</select>")}else m.push('<span id="value">'),inputType="radio",this._field.list.length>7&&!this._field.listSingle&&m.push('(<input type="checkbox" id="checkAll" value="1"/><label for="checkAll">All</label>) '),m.push(e.inputLOV(this._field.list,!this._field.listSingle)),m.push("</span>");break;case d.bool:m.push('<span id="value">',e.inputRadio("value","1",b.yes,"0"!=f,"value1"),e.inputRadio("value","0",b.no,"0"==f,"value0"),"</span>");break;case d.date:case d.time:case d.number:var p=i==d.date?"text":i;m.push('<input id="value" type="',p,'"/>'),k&&m.push('<span class="as-Txt">',b.opAnd," </span>",'<input id="value2" type="',p,'"/>'),l=!1;break;default:m.push('<input id="value" type="text"/>'),l=!1}h.append(m.join("")),i==d.date&&h.find("#value,#value2").datepicker({dateFormat:this.options.dateFormat})}if(f){var q=h.find("#value");switch(i){case d.lov:this.options.enableSelect2?a("#lov").val(f.split(",")):q.find("#"+f.split(",").join(",#")).attr("checked","checked");break;case d.bool:q.find("#value"+f).attr("checked","checked");break;default:q.val(f),l=""!==f,k&&(q.next().next().val(g),l=""!==f&&""!==g)}}else l=i==d.lov||i==d.bool}else h.append(e.inputHidden("value",""));this.options.enableSelect2&&a("#lov").select2({width:"element",placeholder:this._field.listPlaceholder}),this._bAdd.button(l?"enable":"disable").show(),this._step=3}},_getEditorData:function(){var e=this._editor,f=e.find("#field"),g=e.find("#value"),h=e.find("#andOr"),i={field:{label:f.find("option:selected").text(),value:f.val()},operator:{},value:{}},j=i.operator,k=i.value;if(h.val()&&(i.andor={label:h.find("option:selected").text(),value:h.val()}),this._type==d.lov){var l=[],m=[];if(this.options.enableSelect2?a("#lov option:selected").each(function(){l.push(a(this).val()),m.push(a(this).text())}):g.find("input:checked").not("#checkAll").each(function(){l.push(this.value),m.push(this.nextSibling.innerHTML)}),0===l.length&&!this._field.allowNull)return!1;0===l.length&&this._field.allowNull?(j.label=b.sIsNull,j.value=c.sIsNull,k.label=k.value=""):1==l.length?(j.label=b.sEqual,j.value=c.sEqual,k.label=m[0],k.value=l[0]):(j.label=b.sInList,j.value=c.sInList,k.label="("+m.join(", ")+")",k.value=l.join(","))}else if(this._type==d.bool){j.label=b.sEqual,j.value=c.sEqual;var n="checked"==g.find("#value1").attr("checked")?1:0;k.label=1==n?b.yes:b.no,k.value=n}else{var o=e.find("#operator"),p=o.val();j.label=o.find("option:selected").text(),j.value=p,p==c.sIsNull||p==c.sIsNotNull?k.label=k.value="":(k.label=(this._type==d.number||this._type==d.date||this._type==d.time,g.val()),k.value=g.val(),p==c.sBetween&&(k.label2=k.value2=g.next().next().val()))}return i},_hiddenValue:function(a,b,c){a.push(e.inputHidden("fld-"+c,b.field.value),e.inputHidden("op-"+c,b.operator.value),e.inputHidden("val-"+c,b.value.value));var d=b.value.value2;d&&a.push(e.inputHidden("val2-"+c,d))},_setHiddenValues:function(){for(var a=this.val(),b=a.length,c=[e.inputHidden("elem",b)],d=0;b>d;d++)this._hiddenValue(c,a[d],d+1);this._hValues.html(c.join(""))},_triggerChange:function(){this.options.submitReady&&this._setHiddenValues(),this.element.trigger("change.search")},val:function(b){if("undefined"==typeof b){var c=[];return this._filters.find("a").each(function(){c.push(a(this).data("filter"))}),c}this._filters.empty();for(var d=0,e=b.length;e>d;d++)this.addFilter(b[d]);return this._triggerChange(),this},valText:function(){var a=[];return this._filters.find("a").each(function(){a.push(this.text)}),a.join(" "+b.opAnd+" ")},valUrl:function(){var a=this.val(),b=a.length,d=["filters=",b];if(1>b)return"";for(var e=0;b>e;e++){var f=a[e];d.push("&field-",e,"=",f.field.value,"&operator-",e,"=",f.operator.value,"&value-",e,"=",encodeURIComponent(f.value.value)),f.operator==c.sBetween&&d.push("&value2-",e,"=",encodeURIComponent(f.value.value2))}return d.push("&label=",encodeURIComponent(this.valText())),d.join("")},clear:function(){return this._cFilter=null,this._removeEditor(),this._filters.empty(),this._triggerChange(),this},length:function(){return this._filters.children().length},destroy:function(){var b=this.element.off();b.find(".evo-bNew,.evo-bAdd,.evo-bDel,.evo-searchFilters").off(),this._editor.off(),b.clear().removeClass("evo-advSearch ui-widget-content ui-corner-all"),a.Widget.prototype.destroy.call(this)}});var e={inputRadio:function(a,b,c,d,e){var f=['<label for="',e,'"><input id="',e,'" name="',a,'" type="radio" value="',b];return d&&f.push('" checked="checked'),f.push('">',c,"</label>&nbsp;"),f.join("")},inputHidden:function(a,b){return['<input type="hidden" name="',a,'" value="',b,'"/>'].join("")},inputOption:function(a,b){return['<option value="',a,'">',b,"</option>"].join("")},inputLOV:function(a,b){var c=[],d="lov",e="radio";b&&(e="checkbox",d="");for(var f in a){var g=a[f];c.push('<input name="'+d+'" type="'+e+'" id="',g.id,'" value="',g.id,'"/>','<label for="',g.id,'">',g.label,"</label> ")}return c.join("")}}}(jQuery);